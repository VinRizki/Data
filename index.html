<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SAE Input Form</title>
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; max-width: 900px; margin: 2em auto; padding: 1em; background: #f0f3fa; }
  h1 { text-align: center; }
  form, table { background: white; padding: 1.5em 2em; border-radius: 8px; box-shadow: 0 0 12px #ccc; margin-bottom: 2em; }
  form { display: grid; grid-template-columns: 1fr 1fr; gap: 1em 2em; }
  label { font-weight: 600; margin-bottom: 0.4em; display: block; }
  select, input { width: 100%; padding: 0.5em 0.8em; border-radius: 6px; border: 1px solid #aaa; font-size: 1em; }
  button { grid-column: span 2; padding: 0.9em; background: #5a67d8; color: white; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; }
  #scanner-container { display: none; grid-column: span 2; margin-top: 1em; border: 1px solid #aaa; border-radius: 8px; }
  #interactive { width: 100%; height: 250px; }
  table { width: 100%; border-collapse: collapse; }
  th, td { border: 1px solid #ddd; padding: 0.5em; text-align: center; font-size: 0.9em; }
  th { background-color: #e2e8f0; }
  #exportBtn { float: right; margin-top: -2em; margin-bottom: 2em; padding: 0.5em 1em; background: #4c51bf; color: white; border: none; border-radius: 5px; cursor: pointer; }
</style>
</head>
<body>

<h1>SAE Input Form</h1>

<form id="formInput">
  <div>
    <label for="dateInput">Tanggal</label>
    <input type="date" id="dateInput" required />
  </div>

  <div>
    <label for="saeNameSelect">Nama SAE</label>
    <select id="saeNameSelect" required>
      <option value="" disabled selected>Pilih SAE Name</option>
      <option>Aditya Septian</option>
      <option>Ahmad Agus Baidowi Rs</option>
      <option>Bagus Irfansyah</option>
      <option>Erhamna</option>
      <option>Fernanda Putra Herlista</option>
      <option>Kevin Rizki Dwi Putra</option>
      <option>Muhammad Fatikh</option>
      <option>Sarlian Fajrin</option>
    </select>
  </div>

  <div>
    <label for="merchantInput">Merchant Name</label>
    <input type="text" id="merchantInput" placeholder="Merchant Name" required />
  </div>

  <div>
    <label for="serialInput">Serial Number</label>
    <input type="text" id="serialInput" placeholder="Serial Number" required />
    <button type="button" id="btnScanBarcode" style="margin-top: 0.4em;">Scan Barcode</button>
  </div>

  <div id="scanner-container">
    <div id="interactive"></div>
    <button type="button" id="btnStopScan" style="width: 100%; background: #e53e3e; color: white; border: none; padding: 0.6em; border-radius: 6px;">Stop Scanning</button>
  </div>

  <div>
    <label for="completenessSelect">Completeness</label>
    <select id="completenessSelect" required>
      <option value="Complete">Complete</option>
      <option value="Incomplete">Incomplete</option>
    </select>
  </div>

  <div>
    <label for="competencySelect">Competency</label>
    <select id="competencySelect" required>
      <option value="" disabled selected>Pilih Competency</option>
      <option>Withdrawal</option>
      <option>Replacement</option>
      <option>HO</option>
    </select>
  </div>

  <button type="submit">Submit</button>
</form>

<button id="exportBtn">Export ke Excel (CSV)</button>

<table id="entriesTable">
  <thead>
    <tr>
      <th>Tanggal</th>
      <th>SAE Name</th>
      <th>Merchant</th>
      <th>Serial Number</th>
      <th>Completeness</th>
      <th>Competency</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
<script>
  const SPREADSHEET_ID = "1ugQb4jor_IWdQolMutPzB4g0pniAhzJjfAEB5J3_DjM"; // Ganti dengan spreadsheet id Anda yang benar
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxteQocAwV2H84LJdsajt_TBMUP8QSEq6bbZZVigRM1/dev";

  const dateInput = document.getElementById('dateInput');
  const saeNameSelect = document.getElementById('saeNameSelect');
  const merchantInput = document.getElementById('merchantInput');
  const serialInput = document.getElementById('serialInput');
  const completenessSelect = document.getElementById('completenessSelect');
  const competencySelect = document.getElementById('competencySelect');
  const formInput = document.getElementById('formInput');
  const entriesTableBody = document.querySelector('#entriesTable tbody');
  const exportBtn = document.getElementById('exportBtn');
  const btnScanBarcode = document.getElementById('btnScanBarcode');
  const btnStopScan = document.getElementById('btnStopScan');
  const scannerContainer = document.getElementById('scanner-container');

  let scanning = false;
  let entries = [];

  function setToday() {
    const today = new Date();
    const yyyy = today.getFullYear();
    let mm = today.getMonth() + 1;
    let dd = today.getDate();
    if (mm < 10) mm = '0' + mm;
    if (dd < 10) dd = '0' + dd;
    dateInput.value = `${yyyy}-${mm}-${dd}`;
  }
  setToday();

  function refreshTable() {
    entriesTableBody.innerHTML = '';
    entries.forEach(row => {
      const tr = document.createElement('tr');
      [row.date, row.saeName, row.merchant, row.serial, row.completeness, row.competency].forEach(text => {
        const td = document.createElement('td');
        td.textContent = text;
        tr.appendChild(td);
      });
      entriesTableBody.appendChild(tr);
    });
  }

  // Fungsi ambil data dari Sheet untuk SAE yang dipilih
  async function fetchEntries(saeName) {
    try {
      const res = await fetch(`${WEBAPP_URL}?saeName=${encodeURIComponent(saeName)}`);
      const json = await res.json();
      if (json.success) {
        entries = json.data.map(d => ({
          date: d.date,
          saeName: d.saeNameFull,
          merchant: d.merchantName,
          serial: d.serialNumber,
          completeness: d.completeness,
          competency: d.competency
        }));
        refreshTable();
      } else {
        alert('Gagal mengambil data: ' + json.message);
      }
    } catch (err) {
      alert('Error mengambil data: ' + err.message);
    }
  }

  saeNameSelect.addEventListener('change', () => {
    const saeName = saeNameSelect.value;
    if (saeName) fetchEntries(saeName);
    else {
      entries = [];
      refreshTable();
    }
  });

  formInput.addEventListener('submit', async e => {
    e.preventDefault();

    if (!confirm('Apakah Anda yakin ingin mengirim data ini?')) return;

    const dataToSend = {
      date: dateInput.value,
      saeNameFull: saeNameSelect.value,
      merchantName: merchantInput.value.trim(),
      serialNumber: serialInput.value.trim(),
      completeness: completenessSelect.value,
      competency: competencySelect.value
    };

    try {
      const res = await fetch(WEBAPP_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(dataToSend)
      });
      const json = await res.json();
      if (json.success) {
        alert('Data berhasil dikirim!');
        // Refresh data setelah submit
        fetchEntries(dataToSend.saeNameFull);
        // Reset form (tetap pakai tanggal hari ini)
        formInput.reset();
        setToday();
      } else {
        alert('Gagal mengirim data: ' + json.message);
      }
    } catch (err) {
      alert('Error saat mengirim data: ' + err.message);
    }
  });

  exportBtn.addEventListener('click', () => {
    if (entries.length === 0) {
      alert('Tidak ada data untuk diexport.');
      return;
    }
    const header = ['Tanggal', 'Nama SAE', 'Merchant', 'Serial Number', 'Completeness', 'Competency'];
    let csvContent = header.join(',') + '\n';
    entries.forEach(row => {
      const line = [
        row.date,
        `"${row.saeName.replace(/"/g, '""')}"`,
        `"${row.merchant.replace(/"/g, '""')}"`,
        `"${row.serial.replace(/"/g, '""')}"`,
        row.completeness,
        row.competency
      ].join(',');
      csvContent += line + '\n';
    });
    const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'SAE_Entries.csv';
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  });

  // Barcode Scanner logic dengan QuaggaJS
  btnScanBarcode.addEventListener('click', () => {
    if (scanning) return;
    scannerContainer.style.display = 'block';
    Quagga.init({
      inputStream: {
        name: 'Live',
        type: 'LiveStream',
        target: document.querySelector('#interactive'),
        constraints: {facingMode: 'environment'}
      },
      decoder: { readers: ['code_128_reader', 'ean_reader', 'upc_reader', 'upc_e_reader'] }
    }, err => {
      if (err) {
        alert('Error akses kamera: ' + err);
        scannerContainer.style.display = 'none';
        scanning = false;
        return;
      }
      Quagga.start();
      scanning = true;
    });

    Quagga.onDetected(result => {
      if (result && result.codeResult && result.codeResult.code) {
        serialInput.value = result.codeResult.code;
        stopScan();
      }
    });
  });

  btnStopScan.addEventListener('click', () => stopScan());

  function stopScan() {
    if (scanning) {
      Quagga.stop();
      scanning = false;
      scannerContainer.style.display = 'none';
    }
  }
</script>
</body>
</html>
