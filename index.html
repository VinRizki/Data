<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Form Input SAE</title>
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
<style>
  body { max-width: 900px; margin: 2em auto; font-family: Arial, sans-serif; background: #f7f9fc; padding: 1em; }
  h1 { text-align: center; margin-bottom: 1em; }
  form { background: white; padding: 1.5em; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: grid; grid-template-columns: 1fr 1fr; gap: 1.2em; }
  label { font-weight: 600; margin-bottom: 0.3em; display: block; }
  input, select, button { width: 100%; padding: 8px; font-size: 1em; border-radius: 6px; border: 1px solid #ccc; }
  button { background-color: #3f51b5; color: white; font-weight: bold; border: none; cursor: pointer; grid-column: span 2; }
  button:hover { background-color: #303f9f; }
  #scanner-container { display: none; grid-column: span 2; margin-top: 1em; border: 1px solid #ddd; border-radius: 8px; }
  #interactive { width: 100%; height: 260px; }
  table { width: 100%; border-collapse: collapse; margin-top: 2em; }
  th, td { border: 1px solid #ddd; padding: 0.5em 1em; text-align: center; font-size: 0.9em; }
  th { background-color: #e3e6f3; }
  #exportBtn { margin-top: 20px; float: right; padding: 10px 20px; background-color: #3f51b5; color: white; border: none; border-radius: 6px; cursor: pointer; }
</style>
</head>
<body>

<h1>Form Input Data SAE</h1>

<form id="formInput">
  <div>
    <label for="dateInput">Tanggal</label>
    <input type="date" id="dateInput" required />
  </div>

  <div>
    <label for="saeNameSelect">Nama SAE</label>
    <select id="saeNameSelect" required>
      <option value="" disabled selected>Pilih Nama SAE</option>
      <option>Aditya Septian</option>
      <option>Ahmad Agus Baidowi Rs</option>
      <option>Bagus Irfansyah</option>
      <option>Erhamna</option>
      <option>Fernanda Putra Herlista</option>
      <option>Kevin Rizki Dwi Putra</option>
      <option>Muhammad Fatikh</option>
      <option>Sarlian Fajrin</option>
    </select>
  </div>

  <div>
    <label for="merchantInput">Nama Merchant</label>
    <input type="text" id="merchantInput" placeholder="Nama Merchant" required />
  </div>

  <div>
    <label for="serialInput">Nomor Seri</label>
    <input type="text" id="serialInput" placeholder="Nomor Seri" required />
    <button type="button" id="btnScanBarcode" style="margin-top: 5px;">Scan Barcode</button>
  </div>

  <div id="scanner-container">
    <div id="interactive"></div>
    <button type="button" id="btnStopScan" style="width: 100%; background: #d32f2f; color: white; border: none; padding: 10px; border-radius: 6px; margin-top: 10px;">Berhenti Scan</button>
  </div>

  <div>
    <label for="completenessSelect">Kelengkapan</label>
    <select id="completenessSelect" required>
      <option value="Complete">Complete</option>
      <option value="Incomplete">Incomplete</option>
    </select>
  </div>

  <div>
    <label for="competencySelect">Kompetensi</label>
    <select id="competencySelect" required>
      <option value="" disabled selected>Pilih Kompetensi</option>
      <option value="Penarikan">Penarikan</option>
      <option value="Penggantian">Penggantian</option>
      <option value="HO">HO</option>
    </select>
  </div>

  <button type="submit">Submit</button>
</form>

<button id="exportBtn">Export ke Excel (CSV)</button>

<table id="entriesTable">
  <thead>
    <tr>
      <th>Tanggal</th>
      <th>Nama SAE</th>
      <th>Merchant</th>
      <th>Nomor Seri</th>
      <th>Kelengkapan</th>
      <th>Kompetensi</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
<script>
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzRhh3vsNHMwc1QxAmly8JcZIJlGCxIPm0SKDK2FE9yhraVXo_OtA71Y1Fmev3dwWg0Xg/exec";  // Ganti URL Google Apps Script Web App Anda

  // Elemen
  const dateInput = document.getElementById('dateInput');
  const saeNameSelect = document.getElementById('saeNameSelect');
  const merchantInput = document.getElementById('merchantInput');
  const serialInput = document.getElementById('serialInput');
  const completenessSelect = document.getElementById('completenessSelect');
  const competencySelect = document.getElementById('competencySelect');
  const formInput = document.getElementById('formInput');
  const entriesTableBody = document.querySelector('#entriesTable tbody');
  const exportBtn = document.getElementById('exportBtn');
  const btnScanBarcode = document.getElementById('btnScanBarcode');
  const btnStopScan = document.getElementById('btnStopScan');
  const scannerContainer = document.getElementById('scanner-container');

  let scanning = false;
  let entries = [];

  // Set default date ke hari ini
  function setTodayDate() {
    const now = new Date();
    const yyyy = now.getFullYear();
    let mm = now.getMonth() + 1;
    let dd = now.getDate();
    mm = mm < 10 ? '0'+mm : mm;
    dd = dd < 10 ? '0'+dd : dd;
    dateInput.value = `${yyyy}-${mm}-${dd}`;
  }
  setTodayDate();

  // Load data untuk SAE terpilih
  async function loadEntries(saeName) {
    if (!saeName) {
      entries = [];
      renderTable();
      return;
    }
    try {
      const res = await fetch(`${WEBAPP_URL}?saeName=${encodeURIComponent(saeName)}`);
      const json = await res.json();
      if (json.success) {
        entries = json.data.map(row => ({
          date: row.date,
          saeName: row.saeNameFull,
          merchant: row.merchantName,
          serial: row.serialNumber,
          completeness: row.completeness,
          competency: row.competency
        }));
        renderTable();
      } else {
        alert("Gagal mengambil data: " + json.message);
      }
    } catch (e) {
      alert("Error mengambil data: " + e.message);
    }
  }

  saeNameSelect.addEventListener('change', () => {
    loadEntries(saeNameSelect.value);
  });

  function renderTable() {
    entriesTableBody.innerHTML = '';
    entries.forEach(row => {
      const tr = document.createElement('tr');
      [row.date, row.saeName, row.merchant, row.serial, row.completeness, row.competency].forEach(text => {
        const td = document.createElement('td');
        td.textContent = text;
        tr.appendChild(td);
      });
      entriesTableBody.appendChild(tr);
    });
  }

  formInput.addEventListener('submit', async e => {
    e.preventDefault();

    if (!confirm("Apakah Anda yakin ingin mengirim data ini?")) return;

    const data = {
      date: dateInput.value,
      saeNameFull: saeNameSelect.value,
      merchantName: merchantInput.value.trim(),
      serialNumber: serialInput.value.trim(),
      completeness: completenessSelect.value,
      competency: competencySelect.value
    };

    try {
      const res = await fetch(WEBAPP_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(data),
      });
      const json = await res.json();
      if (json.success) {
        alert('Data berhasil disimpan!');
        await loadEntries(data.saeNameFull);
        formInput.reset();
        setTodayDate();
      } else {
        alert('Gagal menyimpan: ' + json.message);
      }
    } catch (error) {
      alert('Terjadi error saat mengirim data: ' + error.message);
    }
  });

  exportBtn.addEventListener('click', () => {
    if (entries.length === 0) {
      alert('Tidak ada data untuk diexport.');
      return;
    }
    const header = ['Tanggal', 'Nama SAE', 'Merchant', 'Nomor Seri', 'Kelengkapan', 'Kompetensi'];
    let csv = header.join(',') + '\r\n';
    entries.forEach(row => {
      const line = [
        row.date,
        `"${row.saeName.replace(/"/g, '""')}"`,
        `"${row.merchant.replace(/"/g, '""')}"`,
        `"${row.serial.replace(/"/g, '""')}"`,
        row.completeness,
        row.competency
      ].join(',');
      csv += line + '\r\n';
    });
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'data_sae.csv';
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  });

  // Barcode scanner
  btnScanBarcode.addEventListener('click', () => {
    if(scanning) return;
    scannerContainer.style.display = 'block';
    Quagga.init({
      inputStream: {
        name: 'Live',
        type: 'LiveStream',
        target: document.querySelector('#interactive'),
        constraints: {
          facingMode: 'environment'
        }
      },
      decoder: {
        readers: ['code_128_reader', 'ean_reader', 'upc_reader', 'upc_e_reader']
      }
    }, err => {
      if (err) {
        alert('Gagal mengakses kamera: ' + err);
        scannerContainer.style.display = 'none';
        scanning = false;
        return;
      }
      Quagga.start();
      scanning = true;
    });
    Quagga.onDetected(result => {
      if (result && result.codeResult && result.codeResult.code) {
        serialInput.value = result.codeResult.code;
        stopScan();
      }
    });
  });

  btnStopScan.addEventListener('click', () => {
    stopScan();
  });

  function stopScan() {
    if(scanning) {
      Quagga.stop();
      scanning = false;
      scannerContainer.style.display = 'none';
    }
  }

  window.onload = () => {
    if(saeNameSelect.value) loadEntries(saeNameSelect.value);
  };
</script>

</body>
</html>
